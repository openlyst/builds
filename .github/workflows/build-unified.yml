name: Build All Repositories

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - altstore
          - fdroid
          - homebrew
          - aur
      platform:
        description: 'Homebrew platform (only for homebrew target)'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - macOS
          - Linux
      calculate_hashes:
        description: 'Calculate SHA256 hashes (slower but more complete)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: "build-repos"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build repositories
        env:
          TARGET: ${{ github.event.inputs.target || 'all' }}
          PLATFORM: ${{ github.event.inputs.platform || 'both' }}
          CALC_HASHES: ${{ github.event.inputs.calculate_hashes || 'false' }}
        run: |
          ARGS="--target $TARGET --platform $PLATFORM --verbose"
          
          if [ "$CALC_HASHES" = "true" ]; then
            ARGS="$ARGS --calculate-sha256 --calculate-info"
          fi
          
          python build.py $ARGS
      
      - name: Generate .SRCINFO for AUR packages
        if: github.event.inputs.target == 'all' || contains(github.event.inputs.target || '', 'aur')
        run: |
          # Stable (-bin) AUR packages only; unstable are generated by Build Apps workflow
          for pkg in aur-packages/*/; do
            pkg=$(basename "$pkg")
            if [ ! -f "aur-packages/$pkg/PKGBUILD" ]; then continue; fi
            docker run --rm \
              -v "$PWD/aur-packages/$pkg:/pkg:rw" \
              archlinux:latest \
              bash -c "pacman -Syu --noconfirm base-devel 2>/dev/null; useradd -m -u 1000 builduser; chown -R builduser:builduser /pkg; su builduser -c 'cd /pkg && makepkg --printsrcinfo > .SRCINFO'"
          done
      
      - name: Setup SSH for AUR
        if: github.event.inputs.target == 'all' || contains(github.event.inputs.target || '', 'aur')
        env:
          AUR_SSH_KEY_BASE64: ${{ secrets.AUR_SSH_KEY_BASE64 }}
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Decode key without adding newlines (printf avoids echo mangling multiline/trailing newline)
          printf '%s' "$AUR_SSH_KEY_BASE64" | base64 -d > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          # Debug: key file sanity (no secret content)
          echo "::notice::AUR SSH key file size: $(wc -c < ~/.ssh/aur_key) bytes"
          if head -1 ~/.ssh/aur_key | grep -q 'BEGIN.*PRIVATE KEY'; then
            echo "::notice::AUR SSH key format: $(head -1 ~/.ssh/aur_key)"
            ssh-keygen -l -f ~/.ssh/aur_key 2>/dev/null || echo "::warning::Could not read key fingerprint (passphrase-protected or invalid key)"
          else
            echo "::error::AUR key file does not look like a PEM private key (check AUR_SSH_KEY_BASE64 is base64 of the private key)"
            exit 1
          fi
          ssh-keyscan -t ed25519,rsa aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "::notice::Added aur.archlinux.org to known_hosts"
      
      - name: Push to AUR
        if: github.event.inputs.target == 'all' || contains(github.event.inputs.target || '', 'aur')
        env:
          AUR_SSH_KEY_PASSWORD: ${{ secrets.AUR_SSH_KEY_PASSWORD }}
        run: |
          set -e
          # Start agent in this step so it stays alive for the whole run (previous step's agent is gone)
          eval "$(ssh-agent -s)"
          echo "::notice::SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
          # Load key into agent (passphrase via stdin so encrypted keys work in CI)
          if printf '%s' "$AUR_SSH_KEY_PASSWORD" | ssh-add ~/.ssh/aur_key 2>/tmp/ssh-add.log; then
            echo "::notice::AUR SSH key loaded into agent"
          else
            echo "::warning::ssh-add failed (check passphrase if key is encrypted):"
            cat /tmp/ssh-add.log || true
          fi
          ssh-add -l
          if ! ssh-add -l | grep -q .; then
            echo "::error::No keys in agent. If key is passphrase-protected, set AUR_SSH_KEY_PASSWORD. If key is unencrypted, check AUR_SSH_KEY_BASE64."
            exit 1
          fi
          # Use agent only (no -i) so the decrypted key from ssh-add is used; -i would re-read the file and prompt for passphrase
          export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts"
          # Optional: quick auth test (no secret output)
          echo "::notice::Testing SSH to aur.archlinux.org..."
          $GIT_SSH_COMMAND -T -o BatchMode=yes -o ConnectTimeout=10 aur@aur.archlinux.org 2>&1 | head -5 || true
          mkdir -p aur-push
          for pkg in aur-packages/*/; do
            pkg=$(basename "$pkg")
            if [ ! -f "aur-packages/$pkg/PKGBUILD" ]; then continue; fi
            echo "Updating AUR package: $pkg"
            if ! git clone --depth 1 "ssh://aur@aur.archlinux.org/${pkg}.git" "aur-push/$pkg" 2>&1; then
              echo "::warning::Clone failed for $pkg (ensure this AUR user has push access to $pkg)"
              continue
            fi
            cp -f "aur-packages/$pkg/PKGBUILD" "aur-packages/$pkg/.SRCINFO" "aur-push/$pkg/" 2>/dev/null || true
            cd "aur-push/$pkg"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add PKGBUILD .SRCINFO
            if ! git diff --staged --quiet; then
              git commit -m "Update to latest from Openlyst API"
              git push origin master
            else
              echo "No changes for $pkg"
            fi
            cd ../..
          done
          rm -rf aur-push
      
      - name: Display build output
        run: |
          echo "=== Build Output Structure ==="
          echo ""
          
          if [ -d "repo" ]; then
            echo "--- AltStore Repository ---"
            ls -lah repo/ 2>/dev/null || echo "Empty"
            echo "Apps in repo:"
            jq -r '.apps[].name' repo/apps.json 2>/dev/null || echo "No apps.json"
            echo ""
          fi
          
          if [ -d "fdroid-repo" ]; then
            echo "--- F-Droid Repository ---"
            ls -lah fdroid-repo/ 2>/dev/null || echo "Empty"
            echo "Metadata files:"
            find fdroid-repo/metadata -name "*.yml" 2>/dev/null | wc -l || echo "0"
            echo ""
          fi
          
          if [ -d "homebrew-tap" ]; then
            echo "--- Homebrew Tap ---"
            ls -lah homebrew-tap/Formula/ 2>/dev/null || echo "Empty"
            echo "Formulae count:"
            find homebrew-tap/Formula -name "*.rb" 2>/dev/null | wc -l || echo "0"
            echo ""
          fi
          
          if [ -d "aur-packages" ]; then
            echo "--- AUR packages (stable -bin only) ---"
            ls -la aur-packages/ 2>/dev/null || echo "Empty"
          fi
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push changes
        run: |
          # Add all output directories
          git add repo/ fdroid-repo/ homebrew-tap/ 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TARGETS="${{ github.event.inputs.target || 'all' }}"
            git commit -m "Update repositories ($TARGETS) - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            
            # Try to push, pull and retry on conflict
            if ! git push; then
              echo "Push failed, pulling latest changes and retrying..."
              git pull origin main --rebase
              git push
            fi
          fi
      
      - name: Upload AltStore artifact
        if: contains(github.event.inputs.target || 'all', 'altstore') || github.event.inputs.target == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: altstore-repo
          path: repo/
          retention-days: 90
          if-no-files-found: ignore
      
      - name: Upload F-Droid artifact
        if: contains(github.event.inputs.target || 'all', 'fdroid') || github.event.inputs.target == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: fdroid-repo
          path: fdroid-repo/
          retention-days: 90
          if-no-files-found: ignore
      
      - name: Upload Homebrew artifact
        if: contains(github.event.inputs.target || 'all', 'homebrew') || github.event.inputs.target == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-tap
          path: homebrew-tap/
          retention-days: 90
          if-no-files-found: ignore
